<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Scene Image ZIP Tool</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
      background-color: #f9f9f9;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      background: white;
      border-radius: 10px;
      overflow: hidden;
    }

    td, th {
      border: 1px solid #ddd;
      padding: 16px;
      vertical-align: top;
      position: relative;
    }

    th {
      background-color: #f0f0f0;
      font-weight: bold;
    }

    .prompt-cell {
      position: relative;
    }

    .copy-btn {
      position: absolute;
      top: 8px;
      right: 8px;
      background: transparent;
      border: none;
      cursor: pointer;
      padding: 4px;
      color: #999;
      transition: color 0.2s;
      visibility: hidden;
    }

    .prompt-cell:hover .copy-btn {
      visibility: visible;
    }

    .copy-btn:hover {
      color: #666;
    }

    .copy-btn:focus {
      outline: none;
    }

    table tbody tr td:first-child {
      width: 10px; 
      text-align: center;
    }

    .image-drop-zone {
      border: 2px dashed #ccc;
      border-radius: 8px;
      padding: 10px;
      min-height: 100px;
      width: 140px;
      text-align: center;
      color: #aaa;
      transition: border-color 0.3s;
      display: flex;
      cursor: pointer;
      align-items: center;
      justify-content: center;
      position: relative;
    }

    .image-drop-zone:focus {
      outline: none;
      border-color: #999;
    }

    .image-drop-zone img {
      max-width: 100px;
      max-height: 100px;
      margin: 0 auto;
    }

    .remove-btn {
      position: absolute;
      top: 8px;
      right: 8px;
      background: transparent;
      border: none;
      color: #999;
      cursor: pointer;
      font-size: 16px;
      padding: 2px;
    }

    .remove-btn:hover {
      color: #333;
    }

    #generateZipBtn, #loadScenes {
      margin-top: 20px;
      padding: 10px 20px;
      background: #4f46e5;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      transition: background 0.2s;
    }

    #generateZipBtn:hover, #loadScenes:hover {
      background: #3730a3;
    }
  </style>
</head>
<body>

<h2>Paste JSON Script</h2>
<textarea id="jsonInput" rows="12" style="width: 100%; padding: 10px;"></textarea><br>
<button id="loadScenes">Load Scenes</button>

<div id="sceneTableContainer"></div>

<button id="generateZipBtn">Download ZIP</button>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script>
  let scriptData = null;
  const imagesByScene = {};

  document.getElementById("loadScenes").addEventListener("click", () => {
    try {
      const json = JSON.parse(document.getElementById("jsonInput").value);
      scriptData = json;
      renderTable(json.script);
    } catch (e) {
      alert("Invalid JSON");
    }
  });

  function renderTable(script) {
    const container = document.getElementById("sceneTableContainer");
    const table = document.createElement("table");
    const thead = table.createTHead();
    const header = thead.insertRow();
    ["Scene", "Prompt", "Image"].forEach(text => {
      const th = document.createElement("th");
      th.textContent = text;
      header.appendChild(th);
    });

    const tbody = document.createElement("tbody");

    Object.entries(script).forEach(([sceneNum, { text, prompt }]) => {
      const row = tbody.insertRow();

      // Scene #
      const sceneCell = row.insertCell();
      sceneCell.textContent = sceneNum;

      // Prompt
      const promptCell = row.insertCell();
      promptCell.className = "prompt-cell";
      promptCell.innerHTML = `<div>${prompt}</div>`;

      const copyBtn = document.createElement("button");
      copyBtn.className = "copy-btn";
      copyBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M16 1H4a2 2 0 0 0-2 2v14h2V3h12V1zM19 5H8a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h11a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2zm0 18H8V7h11v16z"/></svg>`;
      copyBtn.addEventListener("click", () => {
        navigator.clipboard.writeText(prompt).then(() => {
          copyBtn.innerHTML = "✔️";
          setTimeout(() => {
            copyBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M16 1H4a2 2 0 0 0-2 2v14h2V3h12V1zM19 5H8a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h11a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2zm0 18H8V7h11v16z"/></svg>`;
          }, 1000);
        });
      });
      promptCell.appendChild(copyBtn);

      // Image drop zone
      const imageCell = row.insertCell();
      const dropZone = document.createElement("div");
      dropZone.className = "image-drop-zone";
      dropZone.setAttribute("tabindex", "0");

      const dropPlaceholder = document.createElement("span");
      dropPlaceholder.textContent = "Paste or drop an image here";
      dropZone.appendChild(dropPlaceholder);

      const handleImage = (file) => {
        const reader = new FileReader();
        reader.onload = () => {
          const img = new Image();
          img.src = reader.result;
          dropZone.innerHTML = "";
          dropZone.appendChild(img);
          imagesByScene[sceneNum] = new File([file], "scene.jpg", { type: file.type });

          const removeBtn = document.createElement("button");
          removeBtn.className = "remove-btn";
          removeBtn.textContent = "✕";
          removeBtn.addEventListener("click", () => {
            dropZone.innerHTML = "";
            dropZone.appendChild(dropPlaceholder);
            delete imagesByScene[sceneNum];
          });
          dropZone.appendChild(removeBtn);
        };
        reader.readAsDataURL(file);
      };

      // Handle paste
      dropZone.addEventListener("paste", (e) => {
        const items = e.clipboardData.items;
        for (const item of items) {
          if (item.type.startsWith("image/")) {
            const blob = item.getAsFile();
            handleImage(blob);
            e.preventDefault();
            break;
          }
        }
      });

      // Handle drag & drop
      dropZone.addEventListener("dragover", e => e.preventDefault());
      dropZone.addEventListener("drop", e => {
        e.preventDefault();
        const file = e.dataTransfer.files[0];
        if (file && file.type.startsWith("image/")) {
          handleImage(file);
        }
      });

      imageCell.appendChild(dropZone);
    });

    table.appendChild(tbody);
    container.innerHTML = "";
    container.appendChild(table);
  }

  document.getElementById("generateZipBtn").addEventListener("click", async () => {
    if (!scriptData) return alert("Please load a script first.");

    const zip = new JSZip();

    const metaCopy = { ...scriptData };
    zip.file("meta.json", JSON.stringify(metaCopy, null, 2));

    for (const [scene, file] of Object.entries(imagesByScene)) {
      const blob = await file.arrayBuffer();
      const extension = file.name.split('.').pop() || "png";
      zip.file(`${scene}.${extension}`, blob);
    }

    const blob = await zip.generateAsync({ type: "blob" });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = `${(scriptData.title || "zipfile").replace(/[^\w\d-]/g, "_")}.zip`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  });
</script>

</body>
</html>
